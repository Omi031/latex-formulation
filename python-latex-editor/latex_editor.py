#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
LaTeX Êï∞Âºè„Ç®„Éá„Ç£„ÇøÔºàComputer Modern „Éï„Ç©„É≥„ÉàÔºâ
matplotlib + LaTeX „Çí‰ΩøÁî®„Åó„Å¶ÂÆåÂÖ®„Å™ LaTeX „Éá„Éï„Ç©„É´„Éà„Éï„Ç©„É≥„ÉàÂØæÂøú
"""

import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import matplotlib
import json
from pathlib import Path

matplotlib.use("TkAgg")
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from matplotlib.figure import Figure
import matplotlib.patches as mpatches
import os
from datetime import datetime


class LaTeXEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("LaTeX Êï∞Âºè„Ç®„Éá„Ç£„Çø - Computer Modern")
        self.root.geometry("1000x700")
        
        # Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆ„Éë„ÇπÔºà„Ç¢„Éó„É™„Å®Âêå„Åò„Éï„Ç©„É´„ÉÄÔºâ
        app_dir = Path(__file__).parent
        self.config_file = app_dir / "latex_editor_config.json"

        # matplotlib „ÅÆ LaTeX Ë®≠ÂÆö
        plt.rcParams.update(
            {
                "text.usetex": True,
                "font.family": "serif",
                # Computer Modern (TeX„Éá„Éï„Ç©„É´„Éà) „Çí‰ΩøÁî®
                "text.latex.preamble": r"\usepackage{amsmath}\usepackage{amssymb}\usepackage{bm}",
            }
        )

        self.setup_ui()
        self.load_settings()  # Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        self.setup_shortcuts()  # „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Ç≠„Éº„ÇíË®≠ÂÆö
        self.current_equation = r"E = mc^2"
        self.render_equation()
        
        # ÁµÇ‰∫ÜÊôÇ„Å´Ë®≠ÂÆö„Çí‰øùÂ≠ò
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)

    def setup_ui(self):
        """UI „Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó"""
        # „É°„Ç§„É≥„Éï„É¨„Éº„É†
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # ÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥
        input_frame = ttk.LabelFrame(main_frame, text="LaTeX Êï∞Âºè„ÇíÂÖ•Âäõ", padding="10")
        input_frame.grid(
            row=0, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 10)
        )

        self.equation_text = tk.Text(
            input_frame, height=4, width=80, font=("Courier New", 11), undo=True, maxundo=-1
        )
        self.equation_text.insert("1.0", r"E = mc^2")
        self.equation_text.grid(row=0, column=0, sticky=(tk.W, tk.E))

        # „Éú„Çø„É≥„Éï„É¨„Éº„É†
        button_frame = ttk.Frame(input_frame)
        button_frame.grid(row=1, column=0, pady=(5, 0))

        ttk.Button(
            button_frame, text="„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞ (Ctrl+Enter)", command=self.render_equation
        ).pack(side=tk.LEFT, padx=5)
        ttk.Button(button_frame, text="„ÇØ„É™„Ç¢ (Ctrl+L)", command=self.clear_equation).pack(
            side=tk.LEFT, padx=5
        )
        ttk.Button(button_frame, text="üì• ‰øùÂ≠ò (Ctrl+S)", command=self.save_image).pack(
            side=tk.LEFT, padx=5
        )
        ttk.Button(button_frame, text="‚Ü∂ ÂÖÉ„Å´Êàª„Åô (Ctrl+Z)", command=self.undo).pack(
            side=tk.LEFT, padx=5
        )
        ttk.Button(button_frame, text="‚Ü∑ „ÇÑ„ÇäÁõ¥„Åô (Ctrl+Y)", command=self.redo).pack(
            side=tk.LEFT, padx=5
        )

        # „Ç™„Éó„Ç∑„Éß„É≥„Éï„É¨„Éº„É†
        options_frame = ttk.LabelFrame(main_frame, text="„Ç™„Éó„Ç∑„Éß„É≥", padding="10")
        options_frame.grid(
            row=1, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 10)
        )

        # „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
        ttk.Label(options_frame, text="„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫:").grid(
            row=0, column=0, sticky=tk.W
        )
        self.fontsize_var = tk.IntVar(value=24)
        ttk.Spinbox(
            options_frame, from_=12, to=72, textvariable=self.fontsize_var, width=10
        ).grid(row=0, column=1, padx=5)

        # ËÉåÊôØËâ≤
        ttk.Label(options_frame, text="ËÉåÊôØËâ≤:").grid(
            row=0, column=2, sticky=tk.W, padx=(10, 0)
        )
        self.bgcolor_var = tk.StringVar(value="transparent")
        bgcolor_combo = ttk.Combobox(
            options_frame,
            textvariable=self.bgcolor_var,
            values=["transparent", "white", "lightgray"],
            width=12,
        )
        bgcolor_combo.grid(row=0, column=3, padx=5)

        # displaystyle
        self.displaystyle_var = tk.BooleanVar(value=False)
        ttk.Checkbutton(
            options_frame, text="\\displaystyle „Çí‰ΩøÁî®", variable=self.displaystyle_var
        ).grid(row=0, column=4, padx=10)

        # „Éï„Ç°„Ç§„É´ÂêçË®≠ÂÆö
        self.use_equation_filename_var = tk.BooleanVar(value=False)
        ttk.Checkbutton(
            options_frame,
            text="Êï∞ÂºèÂÜÖÂÆπ„Çí„Éï„Ç°„Ç§„É´Âêç„Å´‰ΩøÁî®",
            variable=self.use_equation_filename_var,
        ).grid(row=1, column=0, columnspan=2, sticky=tk.W, pady=(5, 0))
        
        # ‰øùÂ≠òÂΩ¢ÂºèÈÅ∏Êäû
        ttk.Label(options_frame, text="‰øùÂ≠òÂΩ¢Âºè:").grid(
            row=1, column=2, sticky=tk.W, padx=(10, 0), pady=(5, 0)
        )
        self.save_format_var = tk.StringVar(value="svg")
        format_combo = ttk.Combobox(
            options_frame,
            textvariable=self.save_format_var,
            values=["svg", "png", "pdf"],
            state="readonly",
            width=8,
        )
        format_combo.grid(row=1, column=3, padx=5, pady=(5, 0))

        # „Éó„É¨„Éì„É•„Éº„Éï„É¨„Éº„É†
        preview_frame = ttk.LabelFrame(main_frame, text="„Éó„É¨„Éì„É•„Éº", padding="10")
        preview_frame.grid(
            row=2, column=0, columnspan=2, sticky=(tk.W, tk.E, tk.N, tk.S), pady=(0, 10)
        )

        # matplotlib Figure
        self.figure = Figure(figsize=(8, 3), dpi=100)
        self.canvas = FigureCanvasTkAgg(self.figure, master=preview_frame)
        self.canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        # „Çµ„É≥„Éó„É´Êï∞Âºè
        samples_frame = ttk.LabelFrame(
            main_frame, text="„Çµ„É≥„Éó„É´Êï∞ÂºèÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊåøÂÖ•Ôºâ", padding="10"
        )
        samples_frame.grid(row=3, column=0, columnspan=2, sticky=(tk.W, tk.E))

        samples = [
            ("„Ç¢„Ç§„É≥„Ç∑„É•„Çø„Ç§„É≥„ÅÆË≥™Èáè„Ç®„Éç„É´„ÇÆ„ÉºÁ≠â‰æ°Âºè", r"E = mc^2"),
            ("„Ç¨„Ç¶„ÇπÁ©çÂàÜ", r"\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}"),
            ("„Éê„Éº„Çº„É´ÂïèÈ°å", r"\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}"),
            (
                "„Éû„ÇØ„Çπ„Ç¶„Çß„É´ÊñπÁ®ãÂºè",
                r"\nabla \times \bm{E} = -\frac{\partial \bm{B}}{\partial t}",
            ),
            ("‰∫åÊ¨°ÊñπÁ®ãÂºè„ÅÆËß£„ÅÆÂÖ¨Âºè", r"x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}"),
            ("„Ç™„Ç§„É©„Éº„ÅÆÁ≠âÂºè", r"e^{i\pi} + 1 = 0"),
        ]

        for i, (name, eq) in enumerate(samples):
            btn = ttk.Button(
                samples_frame, text=name, command=lambda e=eq: self.insert_sample(e)
            )
            btn.grid(row=i // 2, column=i % 2, sticky=(tk.W, tk.E), padx=5, pady=2)

        # „Ç∞„É™„ÉÉ„ÉâË®≠ÂÆö
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(2, weight=1)

    def render_equation(self):
        """Êï∞Âºè„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞"""
        equation = self.equation_text.get("1.0", tk.END).strip()
        if not equation:
            return

        # displaystyle „ÅÆÈÅ©Áî®
        if self.displaystyle_var.get():
            equation = r"\displaystyle " + equation

        self.current_equation = equation
        fontsize = self.fontsize_var.get()
        bgcolor = self.bgcolor_var.get()

        # Figure „Çí„ÇØ„É™„Ç¢
        self.figure.clear()
        ax = self.figure.add_subplot(111)

        # ËÉåÊôØËâ≤Ë®≠ÂÆö
        if bgcolor == "transparent":
            self.figure.patch.set_alpha(0)
            ax.patch.set_alpha(0)
        elif bgcolor == "white":
            self.figure.patch.set_facecolor("white")
            ax.patch.set_facecolor("white")
        else:
            self.figure.patch.set_facecolor(bgcolor)
            ax.patch.set_facecolor(bgcolor)

        try:
            # ÊîπË°å„ÇíÂê´„ÇÄÊï∞Âºè„ÅÆÂ†¥Âêà„ÅØ„ÄÅalignÁí∞Â¢É„Å™„Å©„Çí‰ΩøÁî®
            # ÈÄöÂ∏∏„ÅÆÊï∞Âºè„ÅØ„Åù„ÅÆ„Åæ„Åæ„ÄÅÊîπË°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈÅ©Âàá„Å´Âá¶ÁêÜ
            equation_formatted = equation
            needs_math_mode = True  # Êï∞Âºè„É¢„Éº„Éâ($...$)„ÅåÂøÖË¶Å„Åã„Å©„ÅÜ„Åã
            
            # „Éá„Éê„ÉÉ„Ç∞Âá∫ÂäõÔºà„Éó„É¨„Éì„É•„ÉºÔºâ
            print("PREVIEW DEBUG: Original equation:")
            print(repr(equation))
            print("PREVIEW DEBUG: Starts with \\begin?", equation.strip().startswith(r'\begin'))
            
            # \begin{...} Áí∞Â¢É„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÉÅ„Çß„ÉÉ„ÇØ
            if equation.strip().startswith(r'\begin'):
                # align, align*, equation, equation*„Å™„Å©„ÅÆÁí∞Â¢É„ÅØÊï∞Âºè„É¢„Éº„Éâ‰∏çË¶Å
                math_environments = ['align', 'align*', 'equation', 'equation*', 
                                   'gather', 'gather*', 'multline', 'multline*']
                for env in math_environments:
                    if equation.strip().startswith(f'\\begin{{{env}}}'):
                        needs_math_mode = False
                        print(f"PREVIEW DEBUG: Detected {env} environment, needs_math_mode = False")
                        break
            elif '\n' in equation:
                # ÊîπË°å„Åå„ÅÇ„Çã„Åå\beginÁí∞Â¢É„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅalignedÁí∞Â¢É„Çí‰ΩøÁî®
                lines = equation.strip().split('\n')
                lines = [line.strip() for line in lines if line.strip()]
                if len(lines) > 1:
                    equation_formatted = r'\begin{aligned}' + r'\\'.join(lines) + r'\end{aligned}'
                    print("PREVIEW DEBUG: Created aligned environment")
            
            print("PREVIEW DEBUG: needs_math_mode =", needs_math_mode)
            print("PREVIEW DEBUG: equation_formatted =", repr(equation_formatted))
            
            # Êï∞Âºè„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            if needs_math_mode:
                math_text = f"${equation_formatted}$"
            else:
                math_text = equation_formatted
            
            print("PREVIEW DEBUG: Final math_text =", repr(math_text))
            
            # matplotlib„Å´Ê∏°„ÅôÂâç„Å´„ÄÅPython„ÅÆÊîπË°å(\n)„ÇíÈô§Âéª
            # LaTeX„ÅÆ\\„ÅØ‰øùÊåÅ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ\n „ÅÆ„Åø„ÇíÂâäÈô§
            math_text_clean = math_text.replace('\n', ' ')
            print("PREVIEW DEBUG: Cleaned math_text =", repr(math_text_clean))
            
            ax.text(
                0.5,
                0.5,
                math_text_clean,
                fontsize=fontsize,
                ha="center",
                va="center",
                transform=ax.transAxes,
            )

            ax.axis("off")
            self.figure.tight_layout(pad=0.1)  # „Éë„Éá„Ç£„É≥„Ç∞„ÇíÊúÄÂ∞èÂåñ
            self.canvas.draw()

        except Exception as e:
            messagebox.showerror(
                "„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Ç®„É©„Éº",
                f"Êï∞Âºè„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Ç®„É©„Éº: {str(e)}\n\nÂÖ•Âäõ: {equation}",
            )

    def clear_equation(self):
        """ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢"""
        self.equation_text.delete("1.0", tk.END)
        self.render_equation()

    def insert_sample(self, equation):
        """„Çµ„É≥„Éó„É´Êï∞Âºè„ÇíÊåøÂÖ•"""
        self.equation_text.delete("1.0", tk.END)
        self.equation_text.insert("1.0", equation)
        self.render_equation()
    
    def undo(self):
        """ÂÖÉ„Å´Êàª„Åô"""
        try:
            self.equation_text.edit_undo()
        except tk.TclError:
            pass  # ÂÖÉ„Å´Êàª„Åõ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    
    def redo(self):
        """„ÇÑ„ÇäÁõ¥„Åô"""
        try:
            self.equation_text.edit_redo()
        except tk.TclError:
            pass  # „ÇÑ„ÇäÁõ¥„Åõ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    
    def setup_shortcuts(self):
        """„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Ç≠„Éº„ÇíË®≠ÂÆö"""
        # Ctrl+Enter: „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞ÔºàÊîπË°å„ÇíÈò≤„ÅêÔºâ
        def on_ctrl_enter(e):
            self.render_equation()
            return "break"  # „Ç§„Éô„É≥„Éà„ÅÆ‰ºùÊí≠„ÇíÂÅúÊ≠¢
        
        # Ctrl+S: ‰øùÂ≠òÔºà„Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤„ÅêÔºâ
        def on_ctrl_s(e):
            self.save_image()
            return "break"
        
        # Ctrl+L: „ÇØ„É™„Ç¢Ôºà„Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤„ÅêÔºâ
        def on_ctrl_l(e):
            self.clear_equation()
            return "break"
        
        # Ctrl+Z: ÂÖÉ„Å´Êàª„Åô
        def on_ctrl_z(e):
            self.undo()
            return "break"
        
        # Ctrl+Y: „ÇÑ„ÇäÁõ¥„Åô
        def on_ctrl_y(e):
            self.redo()
            return "break"
        
        # „ÉÜ„Ç≠„Çπ„Éà„Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà„Å´Áõ¥Êé•„Éê„Ç§„É≥„Éâ
        self.equation_text.bind("<Control-Return>", on_ctrl_enter)
        self.equation_text.bind("<Control-s>", on_ctrl_s)
        self.equation_text.bind("<Control-l>", on_ctrl_l)
        self.equation_text.bind("<Control-z>", on_ctrl_z)
        self.equation_text.bind("<Control-y>", on_ctrl_y)
        
        # „É´„Éº„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´„ÇÇ„Éê„Ç§„É≥„ÉâÔºà‰ªñ„ÅÆÂ†¥ÊâÄ„Åß„ÇÇÂãï‰Ωú„Åô„Çã„Çà„ÅÜ„Å´Ôºâ
        self.root.bind("<Control-Return>", on_ctrl_enter)
        self.root.bind("<Control-s>", on_ctrl_s)
        self.root.bind("<Control-l>", on_ctrl_l)
        self.root.bind("<Control-z>", on_ctrl_z)
        self.root.bind("<Control-y>", on_ctrl_y)

    def save_image(self):
        """ÁîªÂÉè„Çí‰øùÂ≠ò"""
        # ÈÅ∏Êäû„Åï„Çå„ÅüÂΩ¢Âºè„ÇíÂèñÂæó
        format = self.save_format_var.get()
        
        # „Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
        if self.use_equation_filename_var.get():
            import re  # re„É¢„Ç∏„É•„Éº„É´„Çí„Åì„Åì„Åß„Ç§„É≥„Éù„Éº„Éà
            
            # Êï∞Âºè„Åã„Çâ„Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàêÔºàÂÖÉ„ÅÆÂÖ•Âäõ„Åã„ÇâÁîüÊàê„ÄÅÊîπË°å„ÅØÈô§ÂéªÔºâ
            equation = self.equation_text.get("1.0", tk.END).strip()
            equation = equation.replace(r"\displaystyle", "").strip()
            
            # ÊîπË°å„Å®Ë§áÊï∞„ÅÆ„Çπ„Éö„Éº„Çπ„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´Â§âÊèõ
            equation = equation.replace("\n", "_").replace("\r", "")
            equation = re.sub(r'\s+', '_', equation)
            
            # LaTeX„Ç≥„Éû„É≥„Éâ„ÇíÈÅ©Âàá„Å´Â§âÊèõ
            safe_name = equation
            # \command{} ÂΩ¢Âºè„Çí \command_ ÂΩ¢Âºè„Å´Â§âÊèõÔºà{}„ÅÆÂÜÖÂÆπ„ÅØ‰øùÊåÅÔºâ
            # \bm{X} -> bm_X „ÅÆ„Çà„ÅÜ„Å´Â§âÊèõ
            safe_name = re.sub(r'\\(\w+)\{([^}]+)\}', r'\1_\2', safe_name)
            # ÊÆã„Çä„ÅÆ„Éê„ÉÉ„ÇØ„Çπ„É©„ÉÉ„Ç∑„É•„ÇíÂâäÈô§
            safe_name = safe_name.replace("\\", "")
            
            # Windows„Éï„Ç°„Ç§„É´Âêç„Åß‰Ωø„Åà„Å™„ÅÑÊñáÂ≠ó„ÅÆ„Åø„ÇíÂâäÈô§
            # ‰Ωø„Åà„Å™„ÅÑÊñáÂ≠ó: < > : " / \ | ? *
            safe_name = safe_name.replace("<", "")
            safe_name = safe_name.replace(">", "")
            safe_name = safe_name.replace(":", "")
            safe_name = safe_name.replace('"', "")
            safe_name = safe_name.replace("/", "")
            safe_name = safe_name.replace("\\", "")
            safe_name = safe_name.replace("|", "")
            safe_name = safe_name.replace("?", "")
            safe_name = safe_name.replace("*", "")
            
            # „Åù„ÅÆ‰ªñ„ÅÆÁâπÊÆäÊñáÂ≠ó„ÇíÂá¶ÁêÜ
            safe_name = safe_name.replace(" ", "_")
            safe_name = safe_name.replace("{", "").replace("}", "")
            safe_name = safe_name.replace("$", "")
            safe_name = safe_name.replace("(", "").replace(")", "")
            safe_name = safe_name.replace("[", "").replace("]", "")
            safe_name = safe_name.replace(";", "")
            safe_name = safe_name.replace(",", "_")
            
            # Ë§áÊï∞„ÅÆÈÄ£Á∂ö„Åô„Çã„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Çí1„Å§„Å´„Åæ„Å®„ÇÅ„Çã
            safe_name = re.sub(r'_+', '_', safe_name)
            # ÂÖàÈ†≠„Å®Êú´Â∞æ„ÅÆ„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÇíÂâäÈô§
            safe_name = safe_name.strip('_')
            
            # Èï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØÂàá„ÇäË©∞„ÇÅ„Çã
            if len(safe_name) > 80:
                safe_name = safe_name[:80]
            default_name = (
                f"{safe_name}.{format}" if safe_name else f"equation.{format}"
            )
        else:
            # „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çí‰ΩøÁî®
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            default_name = f"equation_{timestamp}.{format}"

        filetypes = {
            "png": [("PNG files", "*.png")],
            "pdf": [("PDF files", "*.pdf")],
            "svg": [("SVG files", "*.svg")],
        }

        filename = filedialog.asksaveasfilename(
            defaultextension=f".{format}",
            filetypes=filetypes[format],
            initialfile=default_name,
        )

        if filename:
            try:
                # Ê•µÂ∞è„Çµ„Ç§„Ç∫„ÅßFigure„Çí‰ΩúÊàê
                save_fig = Figure(
                    figsize=(0.1, 0.1), dpi=300 if format == "png" else 100
                )
                save_ax = save_fig.add_subplot(111)

                bgcolor = self.bgcolor_var.get()
                if bgcolor == "transparent":
                    save_fig.patch.set_alpha(0)
                    save_ax.patch.set_alpha(0)
                elif bgcolor == "white":
                    save_fig.patch.set_facecolor("white")
                    save_ax.patch.set_facecolor("white")
                else:
                    save_fig.patch.set_facecolor(bgcolor)
                    save_ax.patch.set_facecolor(bgcolor)

                # ÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÊï∞Âºè„ÇíÂèñÂæó
                equation = self.equation_text.get("1.0", tk.END).strip()
                if self.displaystyle_var.get():
                    equation = r"\displaystyle " + equation
                fontsize = self.fontsize_var.get()
                
                # „Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ
                print("DEBUG: Original equation:")
                print(repr(equation))
                print("DEBUG: First 50 chars:", equation[:50])
                print("DEBUG: Starts with \\begin?", equation.strip().startswith(r'\begin'))
                
                # Êï∞Âºè„É¢„Éº„Éâ„ÅÆÂà§ÂÆöÔºà„Éó„É¨„Éì„É•„Éº„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØÔºâ
                equation_formatted = equation
                needs_math_mode = True
                
                if equation.strip().startswith(r'\begin'):
                    math_environments = ['align', 'align*', 'equation', 'equation*', 
                                       'gather', 'gather*', 'multline', 'multline*']
                    for env in math_environments:
                        if equation.strip().startswith(f'\\begin{{{env}}}'):
                            needs_math_mode = False
                            print(f"DEBUG: Detected {env} environment")
                            break
                elif '\n' in equation:
                    lines = equation.strip().split('\n')
                    lines = [line.strip() for line in lines if line.strip()]
                    if len(lines) > 1:
                        equation_formatted = r'\begin{aligned}' + r'\\'.join(lines) + r'\end{aligned}'
                        print("DEBUG: Created aligned environment")
                
                print("DEBUG: needs_math_mode =", needs_math_mode)
                print("DEBUG: equation_formatted:")
                print(repr(equation_formatted))
                
                # Êï∞Âºè„ÉÜ„Ç≠„Çπ„Éà„ÇíÁîüÊàê
                if needs_math_mode:
                    math_text = f"${equation_formatted}$"
                else:
                    math_text = equation_formatted
                
                print("DEBUG: Final math_text:")
                print(repr(math_text))
                
                # matplotlib„Å´Ê∏°„ÅôÂâç„Å´„ÄÅPython„ÅÆÊîπË°å(\n)„ÇíÈô§Âéª
                math_text_clean = math_text.replace('\n', ' ')
                print("DEBUG: Cleaned math_text:")
                print(repr(math_text_clean))

                # „ÉÜ„Ç≠„Çπ„Éà„Çí„Éá„Éº„ÇøÂ∫ßÊ®ô„ÅßÈÖçÁΩÆÔºà‰∏≠Â§ÆÈÖçÁΩÆ„Å†„Å®„Çà„ÇäÂØÜÁùÄÔºâ
                text_obj = save_ax.text(
                    0.5,
                    0.5,
                    math_text_clean,
                    fontsize=fontsize,
                    ha="center",
                    va="center",
                    transform=save_ax.transAxes,
                )

                save_ax.axis("off")

                # Ëª∏„ÅÆÁØÑÂõ≤„ÇíË®≠ÂÆö
                save_ax.set_xlim(0, 1)
                save_ax.set_ylim(0, 1)

                # „Éû„Éº„Ç∏„É≥„ÇíÂÆåÂÖ®„Å´„Çº„É≠„Å´
                save_fig.subplots_adjust(
                    left=0, right=1, top=1, bottom=0, wspace=0, hspace=0
                )

                # ‰øùÂ≠òÔºàpad_inches„ÇíÊ•µÈôê„Åæ„ÅßÂ∞è„Åï„ÅèÔºâ
                save_fig.savefig(
                    filename,
                    format=format,
                    bbox_inches="tight",
                    pad_inches=0,  # ÂÆåÂÖ®„Å´„Çº„É≠
                    transparent=(bgcolor == "transparent"),
                    dpi=300 if format == "png" else None,
                )

                # ‰øùÂ≠òÂÆå‰∫ÜÔºàÈÄöÁü•„Å™„ÅóÔºâ

            except Exception as e:
                messagebox.showerror("‰øùÂ≠ò„Ç®„É©„Éº", f"‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n{str(e)}")
    
    def save_settings(self):
        """Ë®≠ÂÆö„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò"""
        try:
            settings = {
                "fontsize": self.fontsize_var.get(),
                "bgcolor": self.bgcolor_var.get(),
                "displaystyle": self.displaystyle_var.get(),
                "use_equation_filename": self.use_equation_filename_var.get(),
                "save_format": self.save_format_var.get(),
            }
            with open(self.config_file, "w", encoding="utf-8") as f:
                json.dump(settings, f, indent=2)
        except Exception as e:
            print(f"Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: {e}")
    
    def load_settings(self):
        """Ë®≠ÂÆö„Çí„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø"""
        try:
            if self.config_file.exists():
                with open(self.config_file, "r", encoding="utf-8") as f:
                    settings = json.load(f)
                    self.fontsize_var.set(settings.get("fontsize", 24))
                    self.bgcolor_var.set(settings.get("bgcolor", "transparent"))
                    self.displaystyle_var.set(settings.get("displaystyle", False))
                    self.use_equation_filename_var.set(settings.get("use_equation_filename", False))
                    self.save_format_var.set(settings.get("save_format", "svg"))
        except Exception as e:
            print(f"Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: {e}")
    
    def on_closing(self):
        """„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„ÇãÈöõ„ÅÆÂá¶ÁêÜ"""
        self.save_settings()
        self.root.destroy()


def main():
    root = tk.Tk()
    app = LaTeXEditor(root)
    root.mainloop()


if __name__ == "__main__":
    main()
